<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
            "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
    <head>
        <title>combobox</title>
        <style type='text/css'>
            body {font-family: verdana}
            .error {border: solid 1px red;}
            .error_text { color: red; font-size: 10px;}
            td {padding: 3px;}
        </style>
        <link type="text/css" href="../smoothness/jquery-ui-1.7.2.custom.css" rel="stylesheet" />		
        <link type="text/css" href="combobox.css" rel="stylesheet" />
    </head>
    <body>

        <div id="combobox_demo"></div>
		<div><h1>Some html that dropdown draws over.</h1></div>
		<div><button type="button">Dummy</button></div>
		<div id="log"></div>
		<div class="commands">
            <input id="someValue" />
			<button id="setValue">Set Value</button>
			<button id="getValue">Get Value</button>
		</div>

        <script type='text/javascript' 
                src='../../steal/steal.js'>   
        </script>
        <script type='text/javascript'>
            steal.plugins("phui/combobox",
                            "jquery/model",
                            "jquery/dom/fixtures").then(function($){
                
                /*$.fixture["-make"](["documents", "document"], 15, function(num, document) {
                    
					    var documentId = parseInt(Math.random() * num);
		                var document = document[documentId]
                        var experiment = parseInt(Math.random() * 10);
			            if (num < 5) {
							return {
							    "text": "dir" + num,
								"type": "folder",
								"disabled": experiment > 6 ? true : false,
								"depth": 0,
		                        "parentId": null,
								children: []
							}
						} else {
						    var child =  { 
								"text": experiment > 6 ? "file" + num : "dir" + num,
								"type": experiment > 6 ? "file" : "folder",
								"disabled": experiment > 6 ? true : false,
								"depth": document.depth + 1,
		                        "parentId": documentId,
								children: []
		                    }
		                    document.children.push(child);
							return child;
						}
                })
				
				// modify fixture to return oly the root items
				var oldFixture = $.fixture["-documents"]; 
			    $.fixture["-documents"] = function(settings){
					var retArr = [];
				    var items = oldFixture(settings)[0].data;
					for(var i=0;i<items.length;i++) {
						var parentId = items[i].parentId;
						if(!parentId && parentId != 0) retArr.push(items[i])
					}
					
					return [{
					    "count": retArr.length,
				    	"data" : retArr
				    }]
			    }				
                
                $.Model.extend("Document",{
                    findAll : function(params, success, error){
                        $.ajax({
                            url: '/document',
                            type: 'get',
                            dataType: 'json',
                            data: params,
                            success: this.callback(['wrapMany',success]),
                            error: error,
                            fixture: "-documents"
                        })
                    }
                },
				{
					setChildren : function(values) {
						return this.Class.wrapMany(values);
					}
				});
                
                $("#combobox_demo").phui_combobox({
                    model: Document,
                    text : "text", 
					maxLookupDepth: 7,
                    render : {
                        text : function(instance){
							var html = [];
							html.push("<span ");
							html.push(" style=\"float:left; margin-left:");
							if(instance.depth) html.push(instance.depth * 20 + "px;"); 
							html.push("display: block;height:13px;\" ");
						    if(instance.type == "folder") html.push(" class=\"ui-icon ui-icon-folder-open\"> ");
							if(instance.type == "file") html.push(" class=\"ui-icon ui-icon-document\"> ");							
							html.push("</span>");
					
							html.push("<span ");
							if(instance.disabled) html.push("style=\"color:#CCCCCC;\" ");
							html.push(">" + instance.text + "</span>")
							
                            return html.join("");
                        }
                    }
                });
				
				
				$("#getValue").bind("click", function(ev){
					var value = $("#combobox_demo").controller().val();
					$("#log").html("<span>" + value.text + "</span>");
				})		
				
				$("#setValue").bind("click", function(ev){
					$("#combobox_demo").controller().val("1");
				})*/
				
				
				
				
				
				$.fixture["-make"](["items", "item"], 15, function(num, item) {
                    
					    var itemId = parseInt(Math.random() * num);
		                var item = item[itemId]
                        var experiment = parseInt(Math.random() * 10);
			            if (num < 5) {
							return {
							    "text": "dir" + num,
								"type": "folder",
								"enabled": experiment > 3 ? true : false,
								"depth": 0,
		                        "parentId": null,
								children: []
							}
						} else {
						    var child =  { 
								"text": experiment > 6 ? "file" + num : "dir" + num,
								"type": experiment > 6 ? "file" : "folder",
								"enabled": experiment > 3 ? true : false,
								"depth": item.depth + 1,
		                        "parentId": itemId,
								children: []
		                    }
		                    item.children.push(child);
							return child;
						}
                })			
				
				// modify fixture to return only the root items
				var oldFixture = $.fixture["-items"]; 
			    $.fixture["-items"] = function(settings){
					var retArr = [];
				    var items = oldFixture(settings)[0].data;
					for(var i=0;i<items.length;i++) {
						var parentId = items[i].parentId;
						if(!parentId && parentId != 0) retArr.push(items[i])
					}
					
					return [{
					    "count": retArr.length,
				    	"data" : retArr
				    }]
			    } 
				
                $.Model.extend("Item",{
                    findAll : function(params, success, error){
                        $.ajax({
                            url: '/item',
                            type: 'get',
                            dataType: 'json',
                            data: params,
                            success: this.callback(['wrapMany',success]),
                            error: error,
                            fixture: "-items"
                        })
                    }
                },
				{
					setChildren : function(values) {
						return this.Class.wrapMany(values);
					}
				});									
				
				// create items to pre-populate combo
				var items = [];
				var rawItems = $.fixture["-items"]({data:{}})[0].data;
				for(var i=0;i<rawItems.length;i++) {
					items.push( new Item(rawItems[i]) );
				}
				 
				$("#combobox_demo").phui_combobox({
                    //items: items,
                    textTemplate: "//phui/combobox/views/default_text_template.ejs",
                    textStyle: "color:blue;font-style:italic;",
                    loadOnDemand: true,
                    showHierarchy: true,
                    maxHeight: "300px",
                    hoverClassName: "hover",
                    selectedClassName: "selected",
					disabledClassName: "disabled",
                    model: Item
                 });							
                
            });
			
            
            steal.start();
            
        </script>
    </body>
</html>